import pandas as pd 
from pathlib import Path

def Main(file_path: str):
    
    table_Name = (file_path.split(sep = "/")[-1]).split(sep = ".")[0]
    df = pd.read_csv(file_path)
    column_Names = (df.keys())
    column_dTypes = []
    column_constraints = []
    
    def data_type_convertor(s: str):
       
        if s == "int64": return "INT"
        if s == "str": return "VARCHAR(50)"
        if s == "float64": return "FLOAT"

    def column_constraints_evaluater(series: pd.Series):

        if not series.isna().sum() > 0: return "NOT NULL"
        elif series.dropna().nunique() == series.dropna().count(): return "UNIQUE"
        else: return ""

    for column in column_Names:
        column_dTypes.append(data_type_convertor(df[column].dtype))
        column_constraints.append(column_constraints_evaluater(df[column]))
    
    SQL_Builder(table_Name,column_Names,column_dTypes,column_constraints,df)

def insert_statement_builder(table_Name: str,column_Names: list,df: pd.DataFrame,SQL: list):
    for i in range(len(df)):
        insert_statement = ["INSERT INTO "+table_Name+" VALUES ("]
        row_values = []
        for column in column_Names:
            value = df.iloc[i][column]
            if pd.isna(value):
                row_values.append("NULL")
            else:
                row_values.append(str(value))
        insert_statement.append(",".join(row_values) + ")\n")
        SQL.append("".join(insert_statement))
    
    print("".join(SQL))

def SQL_Builder(table_Name: str,column_Names: list,column_dTypes: list,column_constraints: list,df: pd.DataFrame):
    
    SQL = []
    SQL.append("CREATE TABLE "+table_Name+" (\n")
    
    SQL.append(column_Names[0]+" "+column_dTypes[0]+" PRIMARY KEY "+column_constraints[0]+",\n") #First Column is PRIMARY KEY
    for i in range(1,len(column_Names)):
        SQL.append(column_Names[i]+" "+column_dTypes[i]+" "+column_constraints[i]+",\n")
    
    last_line = SQL.pop()
    SQL.append(last_line.rstrip(',\n') + "\n")
    SQL.append(");\n")
    insert_statement_builder(table_Name,column_Names,df,SQL)

Main(str(Path(__file__).parent.parent/"raw/customers.csv"))
